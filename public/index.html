<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
        Remove this if you use the .htaccess -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Easymeter</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Optimierungen für mobile Browser: j.mp/bplateviewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Place favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <!-- CSS : implied media="all" -->
    <link type="text/css" href="/css/bootstrap.min.css" rel="stylesheet" />
    <style type="text/css">
        body {
            padding-top: 60px;
            padding-bottom: 40px;
        }
    </style>

    <!-- All JavaScript at the bottom, except for Modernizr which enables HTML5 elements & feature detects -->
    <script src="/js/libs/modernizr-2.5.3.min.js"></script>
</head>
<body>
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>
            <a class="brand" href="#">Burkhardt Heimautomation</a>
            <div class="nav-collapse">
                <ul class="nav">
                    <li class="active"><a href="#">Übersicht</a></li>
                    <li><a href="#contact">Systemsteuerung</a></li>
                    <li><a href="#about">Voraussichtliche Kosten</a></li>
                    <li><a href="#contact">Statisiken</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </div>
</div>

<div class="container">

    <!-- Main hero unit for a primary marketing message or call to action -->
    <div class="hero-unit" style="padding: 0px;">
        <div id="chart_div"></div>
    </div>

    <!-- Example row of columns -->
    <div class="row">
        <div class="span4">
            <h2>Verbrauch Heute</h2>
            <p id="counterToday"></p>
            <p id="counterTodayAverage"></p>
            <p id="counterTodayCost"></p>
            <p><a class="btn" href="#">Tagesdaten »</a></p>
        </div>
        <div class="span4">
            <h2>Verbrauch Monat</h2>
            <p id="counterMonth"></p>
            <p id="counterMonthAverage"></p>
            <p id="counterMonthCost"></p>
            <p><a class="btn" href="#">Monatsdaten »</a></p>
        </div>
        <div class="span4">
            <h2>Zählerstand</h2>
            <p id="counterComplete"></p>
            <p id="counterCompleteYear"></p>
            <p id="counterCompleteYearCost"></p>
            <p><a class="btn" href="#">Jahresdaten »</a></p>
        </div>
    </div>

    <hr>

    <footer>
        <p>© Kersten Burkhardt 2012</p>
    </footer>

</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/libs/jquery-1.7.1.min.js"><\/script>')</script>

<script src="/js/plugins.js"></script>
<script src="/js/script.js"></script>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/xdate.js"></script>

<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript">

    var socket = io.connect();

    var today = 0;
    var todayFunc = function () {
        socket.emit('today', function (data) {
            $('#counterToday').text(data + ' kWh (' + (Math.floor(0.2329*data * 100) / 100) + '€)');
            $('#counterTodayAverage').text((Math.floor((data / (parseInt((new XDate()).toString("H") * 60) + (new XDate()).toString("m"))) * 60 * 100) / 100) + ' kW pro Stunde');
            $('#counterTodayCost').text('Heute voraussichtlich ' + (Math.floor((0.2329*data) / parseInt((new XDate()).toString("H")) * 24 * 100) / 100) + '€ Kosten');
        });

        setTimeout(todayFunc, 5000);
    };

    todayFunc();

    var monthFunc = function () {
        socket.emit('month', function (data) {
            $('#counterMonth').text(data + ' kWh (' + (Math.floor(0.2329*data * 100) / 100) + '€)');
            $('#counterMonthAverage').text((Math.floor((data / parseInt((new XDate()).toString("d"))) * 100) / 100) + ' kW pro Tag');
            $('#counterMonthCost').text('Voraussichtlich ' + (Math.floor((0.2329*data / (new XDate()).getDate()) * 100 * XDate.getDaysInMonth((new XDate()).getFullYear(), (new XDate()).getMonth())) / 100) + '€ Kosten diesen Monat');
        });

        setTimeout(monthFunc, 5000);
    };

    monthFunc();

    var counterFunc = function () {
        socket.emit('complete', function (data) {
            $('#counterComplete').text(data.complete + ' kWh');
            $('#counterCompleteYear').text(data.year + ' kWh dieses Jahr (' + (Math.floor(0.2329*data.year * 100) / 100) + '€)');
            $('#counterCompleteYearCost').text('Voraussichtlich ' + (Math.floor((0.2329*data.year / (new XDate()).getMonth()) * 100 * 12) / 100) + '€ Kosten dieses Jahr');
        });

        setTimeout(counterFunc, 5000);
    };

    counterFunc();

    // Load the Visualization API and the piechart package.
    google.load('visualization', '1.1', {'packages':['corechart']});

    // Set a callback to run when the Google Visualization library is loaded.
    google.setOnLoadCallback(drawChart);

    // Callback that creates and populates a data table,
    // instantiates the pie chart, passes in the data and
    // draws it.
    var options = {
        title: 'Aktueller Stromverbrauch (maximal 2 Minuten)',
        titleTextStyle: {color: 'black', fontSize: 30},
        curveType: "function",
        width: 940,
        height: 290,
        animation: {
            duration: 1000,
            easing: 'inAndOut'
        },
        backgroundColor: { fill: 'transparent' },
        'vAxis.baseline': 0,
        'vAxis.viewWindow.min': 0,
        'vAxis.title': 'Watt',
        legend: {position: 'none'},
        chartArea: {width: '90%'},
        vAxis: {textPosition: 'in', minValue: 0},
        pointSize: 4,
        series: { 0: {color: 'red'}  }
    };

    var chart;
    var data = [
        ['Uhrzeit', 'Verbrauch']
    ];

    function drawChart() {
        chart = new google.visualization.LineChart(document.getElementById('chart_div'));

        socket.on('data', function (rawData) {
            var date = new XDate(new Date(rawData.date));
            data.push([date.toString("HH:mm:ss"), rawData.counter]);

           today += rawData.counter / 12;

            if (data.length >= 60) {
                data.splice(1, 1);
            }

            renderData();
        });
    }

    function renderData() {
        var gData = google.visualization.arrayToDataTable(data);
        chart.draw(gData, options);
    }
</script>
</body>
</html>